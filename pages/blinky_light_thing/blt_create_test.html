<!--
The Blinky Light Thing (BLT) Bluetooth Low Energy version uses Web BLE to communicate from your browser to an ESP32 bluetooth enabled device (your BLT).  It allows you to pass two parameters from the web page:
    1) the binary message to be blinked by the BLT.  This is the UID of the Ethereum Attestation Services attestation that marks the beginning of the presenters broadcast.  
    2) the blink rate at which the BLT will blink out the message.

The BLT has two LEDs.  A blue LED is used to blink the message, a red LED is used to indicate the beginning / end of a message.  When the BLT is not connected the red LED will remain on constantly, once connected the message will begin broadcasting automatically.

** Note: in the brave browser Web Bluetooth is disabled by default.  To fix this navigate to brave://flags/ and search for Bluetooth -> enable the "Web Bluetooth API"

Acknowledgements:  A good portion of this code was based on the project https://RandomNerdTutorials.com/esp32-web-bluetooth/ by Rui Santos -- Thanks for the help!

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>BLT Create - Web BLE App</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./blt_assets/blt_css/style.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.5.2/css/all.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ethereum-attestation-service/eas-sdk@0.28.2/dist/umd/eas-sdk.min.js"></script>
</head>

<body>
    <header>
        <nav>
            <img src="../../assets/img/zeroth_logo.svg"; width=100px; alt="Zeroth Logo">
          <ul>
            <li><a href="../../index.html">Home</a></li>
            <li><a href="https://zeroth-tech.github.io/blogs/">Our Writings</a></li>
          </ul>
        </nav>
    </header>
    <main>
        <br><br><br><br><br><br>
        <div class="container">
            <section id="overview" style="font-family: poppins, sans-serif"></section>
            <h1><i class="fa-solid fa-lightbulb"></i>  BLT Web BLE App</h1>
            <p><i>that's shorthand for Blinky Light Thing Web Bluetooth Low Energy Application</i></p>
            <br>
            <h2>Step 1: Connect your BLT</h2>
            <button id="connectBleButton">Connect BLT</button>
            <p>BLT state: <strong><span id="bleState" style="color:#d13a30;">Disconnected</span></strong></p>
            <div><label for="blink_rate">Blink Rate (ms):</label><input type="number" id="blink_rate" value="200"></div>
            <br>
            <h2>Step 2: Attest to yourself!</h2>
            <p><i> This will route you to <a href="attest.org">Ethereum Attestation Services (EAS)</a> where you will need a wallet to attest with the <a href="https://easscan.org/schema/view/0xe97cac0bc14e959c19b7f21d33f5869194092dd7d700f04fca3a483c848f7807">BLT Create schema</a></i></p>
            <button id="attestButton">Attest on EAS</button>
            <br>
            <label for="message">EAS UID:</label><input type="text" id="message" maxlength="64" value="0x144fec63505680f8f0a6dee7e3b16f0f147715586aa0fe6e7ee65b940d23c570"><br>
            <br>
            <h2>Step 3: Link your stream</h2>
            <label for="streamLink">URL for your video stream:</label><input type="text" id="streamLink" value="https://"> 
            <br><br>
            <h2>Step 4: Share this code</h2>
            <table>
                <tr>
                    <td style="padding: 10px;""><i>This QR code contains a link to a verifier for your video. <br> Embedded in the link is the UID from EAS (the code to be verified), the configuration of your BLT, and the link to your video stream</i></td>
                    <td id="qrcode"></td>
                </tr>
            </table>
            <h2>Step 4: Start Blinking</h2>
            <button id="startBlinking">Start Blinking</button>
            <button id="stopBlinking">Stop Blinking</button>
            <br>
            <br>
            <br>
            <br>
            <br>
        </div>
    </main>
    <footer>
        <a href="https://zeroth.technology" style="color: white; text-decoration: none;">
          <p>&copy; 2024 Zeroth Techonology, Inc All rights reserved.</p>
        </a>
      </footer>
</body>

<script>
    // DOM Elements
    const connectButton = document.getElementById('connectBleButton');
    const bleStateContainer = document.getElementById('bleState');
    const startButton = document.getElementById('startBlinking');
    const stopButton = document.getElementById('stopBlinking');

    //Define BLE Device Specs
    var deviceName ='Blinky Light Thing';
    var bleService = '4cd47158-cf67-4d2c-b1f0-59660de55dbd';
    var binaryMessageCharacteristic = '9ef2820a-ef7e-4a5d-be9c-51af823764cb';
    var blinkRateCharacteristic= 'c074ce76-ffbd-472a-8299-6465f061ac8b';

    //Global Variables to Handle Bluetooth
    var bleServer;
    var bleServiceFound;

    // create attestation on EAS
 
    const EAS_SCHEMA = "0x7857669b61110d06c2188f9b218bb90facf96ffe2ec59d9657dfd1b529c23e7a";
    const EAS_CONTRACT_ADDRESS = "0xC2679fBD37d54388Ce493F1DB75320D236e1815e"; // Sepolia testnet address

    async function attestOnEAS() {
        if (typeof window.ethereum === 'undefined') {
            alert('Please install MetaMask to use this feature');
            return;
        }

        try {
            // Request account access
            await window.ethereum.request({ method: 'eth_requestAccounts' });

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();

            // Initialize EAS SDK
            const eas = new EAS(EAS_CONTRACT_ADDRESS);
            eas.connect(signer);

            // Prepare attestation data
            const attestationData = {
                recipient: await signer.getAddress(),
                expirationTime: 0, // No expiration
                revocable: true,
                data: ethers.utils.defaultAbiCoder.encode(
                    ['string', 'string'], // Adjust these types based on your schema
                    ['BLT Device', 'Some additional data']
                )
            };

            // Create attestation
            const tx = await eas.attest({
                schema: EAS_SCHEMA,
                data: attestationData,
            });

            const newAttestationUID = await tx.wait();

            console.log("Attestation created with UID:", newAttestationUID);
            alert("Attestation created successfully!");
        } catch (error) {
            console.error("Error during attestation:", error);
            alert("Error during attestation. Check console for details.");
        }
    }

    document.getElementById('attestButton').addEventListener('click', attestOnEAS);


    // Generate QR Code
    new QRCode(document.getElementById("qrcode"), {
        text: "https://easscan.org/attestation/view/" + message,
        width: 128,
        height: 128
    });

    // Connect Button (search for BLE Devices only if BLE is available)
    connectButton.addEventListener('click', (event) => {
        if (isWebBluetoothEnabled()){
            connectToDevice();
        }
    });

    // Write to BLT to start and stop blinking
    startButton.addEventListener('click', function(){
        //update the message from the message field
        const hexMessage = document.getElementById('message').value;
        //update the blink rate from the blink rate field
        const blinkRate = document.getElementById('blink_rate').value;
        writeCharacteristic(hexMessage,blinkRate);
    })
    stopButton.addEventListener('click', function(){
        //update the message from the message field
        const hexMessage = document.getElementById('message').value;
        //update the blink rate from the blink rate field
        const blinkRate = 0;
        writeCharacteristic(hexMessage,blinkRate);
    })

    // Check if BLE is available in your Browser
    function isWebBluetoothEnabled() {
        if (!navigator.bluetooth) {
            console.log("Web Bluetooth API is not available in this browser!");
            bleStateContainer.innerHTML = "Web Bluetooth API is not available in this browser!";
            return false
        }
        console.log('Web Bluetooth API supported in this browser.');
        return true
    }
    // Connect to BLE Device 
    function connectToDevice(){
        console.log('Initializing Bluetooth...');
        navigator.bluetooth.requestDevice({
            filters: [{name: deviceName}],
            optionalServices: [bleService]
        })
        .then(device => {
            console.log('Device Selected:', device.name);
            bleStateContainer.innerHTML = 'Connected to ' + device.name;
            bleStateContainer.style.color = "#24af37";
            //device.addEventListener('gattservicedisconnected', onDisconnected);
            return device.gatt.connect();
        })
        .then(gattServer =>{
            bleServer = gattServer;
            console.log("Connected to GATT Server");
            return bleServer.getPrimaryService(bleService);
        })
        .then(service => {
            bleServiceFound = service;
            console.log("Service discovered:", service.uuid);
            return service.getCharacteristic(binaryMessageCharacteristic);
        })
        .catch(error => {
            console.log('Error: ', error);
        })
    }

    function writeCharacteristic(hexMessage,blinkRate){
        if (bleServer && bleServer.connected) {
            bleServiceFound.getCharacteristic(binaryMessageCharacteristic)
            .then(characteristic => {
                console.log ("found the binary message characteristic: ", characteristic.uuid);
                //convert the hex message to binary
                let binaryMessage = hexToBinary(hexMessage);
                console.log("converted ", hexMessage, " to ", binaryMessage);
                //encode the binary message string as an Array Buffer encoded in UTF-8 to pass to the BLE
                const encoder = new TextEncoder();
                return characteristic.writeValue(encoder.encode(binaryMessage));
            })
            bleServiceFound.getCharacteristic(blinkRateCharacteristic)
            .then(characteristic => {
                console.log ("found the blink rate characteristic: ", characteristic.uuid);
                // encode the blink rate int as UintArray
                const buffer = new ArrayBuffer(4);
                const view = new DataView(buffer);
                view.setInt32(0,blinkRate,true); // true for little-endian
                return characteristic.writeValue(buffer);
            })
        } else {
            console.error ("Bluetooth is not connected. Cannot write to characteristic.")
            window.alert("Bluetooth is not connected. Cannot write to characteristic. \n Connect to BLE first!")
        }
    }
    
    function hexToBinary(hexString) {
        // Check for leading '0x' and trim it
        if (hexString.startsWith('0x')) {
            hexString = hexString.slice(2);
        }
        // Dictionary to map hex digits to binary
        const hexToBinMap = {
            '0': '0000', '1': '0001', '2': '0010', '3': '0011',
            '4': '0100', '5': '0101', '6': '0110', '7': '0111',
            '8': '1000', '9': '1001', 'a': '1010', 'b': '1011',
            'c': '1100', 'd': '1101', 'e': '1110', 'f': '1111',
            'A': '1010', 'B': '1011', 'C': '1100', 'D': '1101',
            'E': '1110', 'F': '1111'
        };

        // Initialize an empty string for the binary result
        let binaryString = '';

        // Convert each hex digit to binary
        for (let i = 0; i < hexString.length; i++) {
            const digit = hexString[i];
            if (hexToBinMap[digit] !== undefined) {
                binaryString += hexToBinMap[digit];
            } else {
                throw new Error(`Invalid hexadecimal digit: ${digit}`);
            }
        }

        return binaryString;
    }
    function toggleDarkMode() {
        const body = document.body;
        if (body.classList.contains('light-mode')) {
            body.classList.remove('light-mode');
            body.classList.add('dark-mode');
        } else {
            body.classList.remove('dark-mode');
            body.classList.add('light-mode');
        }
    }
</script>
</html>